 <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="module" src="billing.js"></script>
    <title>Billing Toolkit</title>
    <style>
      :root {
        --blue: #acdbf9;
        --pink: #f8c9f9;
        --pink-dark: #e8b3e8;
        --ink: #333;
        --border: #000;
        --table-border: #333;
      }

      * {
        box-sizing: border-box;
      }

      body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      background: #acdbf9;
      color: #333;
      padding: 2em;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    input[type="file"], button {
      margin: 1em 0;
      padding: 0.8em 1.5em;
      border-radius: 30px;
      border: 1px solid #000;
      font-size: 1em;
      background: #f8c9f9;
      transition: background-color 0.2s;
    }
    button:disabled { background: #f0d4f0; color: #999; border: 1px solid #999; cursor: not-allowed; }
    button:hover:not(:disabled), input[type="file"]:hover { background: #e8b3e8; }
    #output { white-space: pre-wrap; background: #fff; padding: 1em; border-radius: 6px; margin-top: 1em; width: 100%; min-height: 200px; box-sizing: border-box;}
    .back-home {
      display: inline-block;
      padding: 12px 24px;
      background-color: #f8c9f9;
      color: #333;
      text-decoration: none;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 30px;
      text-align: center;
      border: 1px solid #000;
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 999;
      transition: background-color 0.2s ease;
    }
    .back-home:hover { background: #e8b3e8; }
    #notification {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f8c9f9;
      color: #333;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      h1 {
        text-align: center;
        margin: 0;
        font-size: 2.1rem;
        letter-spacing: 0.02em;
      }

      .workflow {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }

      .card {
        background-color: #ffffff;
        border: 2px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .card h2 {
        margin: 0;
        text-align: center;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding-bottom: 12px;
      }

      .help-text {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.4;
        text-align: center;
      }

      input[type="file"] {
        padding: 12px 24px;
        border: 1px solid var(--border);
        border-radius: 30px;
        background-color: var(--pink);
        color: var(--ink);
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        align-self: center;
        transition: background-color 0.2s ease;
      }

      input[type="file"]:hover {
        background-color: var(--pink-dark);
      }

      input[type="file"]::file-selector-button {
        font-size: 1rem;
        padding: 10px 20px;
        border: 1px solid var(--border);
        border-radius: 30px;
        background-color: var(--pink);
        color: var(--ink);
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      input[type="file"]::file-selector-button:hover {
        background-color: var(--pink-dark);
      }

      button {
        display: inline-block;
        padding: 12px 24px;
        background-color: var(--pink);
        color: var(--ink);
        font-size: 1rem;
        font-weight: bold;
        border: 1px solid var(--border);
        border-radius: 30px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      button:hover {
        background-color: var(--pink-dark);
      }

      button:disabled {
        background-color: #f0d4f0;
        color: #999;
        border: 1px solid #999;
        cursor: not-allowed;
      }

      .actions {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .summary-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.95rem;
      }

      .summary-list li {
        padding: 8px 12px;
        background: rgba(172, 219, 249, 0.35);
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.12);
      }

      .client-picker {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
      }

      .client-picker select {
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        font-size: 1rem;
      }

      #preview-card h2 {
        border-bottom: none;
        text-align: left;
        margin-bottom: -4px;
      }

      #previewStatus {
        margin: 0;
        font-size: 0.95rem;
        color: rgba(51, 51, 51, 0.75);
      }

      .client-info h3 {
        margin: 8px 0 4px;
        font-size: 1.3rem;
      }

      .client-info p {
        margin: 0;
        line-height: 1.35;
      }

      .table-wrap {
        overflow-x: auto;
        border: 2px solid var(--table-border);
        border-radius: 12px;
        background:  #ffffff;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
      }

      th,
      td {
        border: 1px solid var(--table-border);
        padding: 10px;
        white-space: nowrap;
        background-color: var(--blue);
        color: var(--ink);
        font-size: 0.92rem;
      }

      th {
        background-color: #ffffff;
        font-weight: bold;
      }

      td.numeric {
        text-align: right;
      }

      #balanceSummary {
        margin: 10px 0 0;
        font-weight: 600;
        text-align: right;
      }

      .notification {
        position: fixed;
        top: 16px;
        right: 16px;
        padding: 10px 18px;
        background-color:  #ffffff;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-weight: 600;
        display: none;
        z-index: 1000;
      }

      @media (max-width: 640px) {
        body {
          padding-top: 120px;
        }

        .back-home {
          position: static;
          margin: 10px auto 0;
          display: block;
          text-align: center;
        }

        .card {
          padding: 20px;
        }

        .workflow {
          grid-template-columns: 1fr;
        }
      }
    </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@7.5.0/build/index.js"></script>
  </head>
  <body>
    <a href="index.html" class="back-home">Back to Home</a>
    <div class="container">
         <h1>Billing Toolkit</h1>
    <div class="workflow">

      <!-- Step 1: PDF Extraction -->
      <section class="card" id="pdf-section">
        <h2>Extract From PDF</h2>
        <p class="help-text">
          Upload a PDF statement to identify invoice tables and export them into an Excel workbook or Word Document.
        </p>
        <input type="file" id="pdfInput" accept="application/pdf" />
        <div class="actions">
          <button id="exportExcelBtn" disabled>Export Extracted Excel</button>
          <button id="exportWordBtn" disabled>Export Extracted Word</button>
        </div>
        <section class="card" id="excel-section">
          <h2>Generate Statements</h2>
          <p class="help-text">
            Add finishing touches 
          <div class="actions">
            <input type="file" id="wordInput" accept=".doc,.docx" />
            <button id="downloadWordBtn" disabled>Download Processed Word</button>
          </div>
          </div>
                  <div id="output"></div>
        <ul id="pdfSummary" class="summary-list"></ul>
    <div id="notification" class="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@7.5.0/build/index.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

const HEADERS = [
  "Claim Number",
  "Service Date",
  "Procedure (and Codes)",
  "Units",
  "Unit Rate",
  "Total Charge",
  "Patient Charge",
  "Total Paid",
  "Insurance Paid",
  "Patient Paid",
  "Total Adjustment",
  "Total Balance",
  "Insurance Balance",
  "Balance Owed"
];

let sheets = []; // Array of objects: {infoLines, tableRows}

function cleanLine(line) {
  return line
    .replace(/State\s+of\s+South\s+Dakota\s+Department\s+of\s+Health/gi, '')
    .replace(/South Dakota Department of Health/gi, '')
    .replace(/600\s+E\s+Capitol\s+Ave/gi, '')
    .replace(/Pierre,\s+SD\s+57501/gi, '')
    .replace(/Payment Type:.*$/i, '')
    .replace(/Card Type:.*$/i, '')
    .replace(/Name on Card:.*$/i, '')
    .replace(/Card Number:.*$/i, '')
    .replace(/Expiration Date:.*$/i, '')
    .replace(/Amount Enclosed:.*$/i, '')
    .replace(/Clients Name(s):.*$/i, '')
    .trim();
}

function showNotification(msg) {
  const n = document.getElementById("notification");
  n.textContent = msg;
  n.style.display = "block";
  setTimeout(() => { n.style.display = "none"; }, 3000);
}

function parseTableRow(line) {
  const tokens = line.trim().split(/\s+/);
  if (tokens.length < 5) return Array(HEADERS.length).fill('');
  let dateIdx = tokens.findIndex(tok => /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(tok));
  if (dateIdx === -1) return Array(HEADERS.length).fill('');
  const claimNumber = tokens.slice(0, dateIdx).join(' ');
  const serviceDate = tokens[dateIdx];
  let i = dateIdx + 1;
  let procedureTokens = [];
  while (i < tokens.length && !/^\d+$/.test(tokens[i])) {
    procedureTokens.push(tokens[i]);
    i++;
  }
  const procedure = procedureTokens.join(' ');
  const units = tokens[i] || '';
  i++;
  const unitRate = tokens[i] || '';
  i++;
  let rest = [];
  while (i < tokens.length) {
    rest.push(tokens[i]);
    i++;
  }
  while (rest.length < 9) rest.push('');
  return [
    claimNumber,
    serviceDate,
    procedure,
    units,
    unitRate,
    rest[0],
    rest[1],
    rest[2],
    rest[3],
    rest[4],
    rest[5],
    rest[6],
    rest[7],
    rest[8]
  ];
}

function processExtractedSheet(flattened) {
  let infoLines = [];
  let headerIdx = flattened.findIndex(l => l.toLowerCase().startsWith("claim number"));
  if (headerIdx > 0) {
    infoLines = flattened.slice(0, headerIdx);
  }
  let tableLines = [];
  if (headerIdx !== -1) {
    for (let i = headerIdx + 1; i < flattened.length; i++) {
      let line = flattened[i];
      if (/^totals?/i.test(line) || /^balances?/i.test(line) || /^patient'?s unapplied balance/i.test(line) || /disclaimer/i.test(line)) break;
      if (line.trim()) tableLines.push(line);
    }
  }
  const tableRows = tableLines.map(parseTableRow);
  sheets.push({infoLines, tableRows});
}

// PDF Extraction
document.getElementById('pdfInput').addEventListener('change', async function(event) {
  const file = event.target.files[0];
  if (!file) return;
  sheets = [];
  document.getElementById('output').textContent = "Extracting PDF...";
  document.getElementById('exportExcelBtn').disabled = true;
  document.getElementById('exportWordBtn').disabled = true;
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdfData = new Uint8Array(arrayBuffer);
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
    let currentSheetData = [];
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      let line = '';
      let lastY = null;
      textContent.items.forEach(item => {
        if (lastY !== null && Math.abs(item.transform[5] - lastY) > 10) {
          line = cleanLine(line);
          if (line.includes("Disclaimer: Charges/Adjustments made after statement date")) {
            if (currentSheetData.length > 0) {
              processExtractedSheet(currentSheetData.map(r => r.trim()).filter(Boolean));
              currentSheetData = [];
            }
          } else {
            currentSheetData.push(line.trim());
          }
          line = '';
        }
        line += item.str + ' ';
        lastY = item.transform[5];
      });
      if (line.trim()) {
        line = cleanLine(line);
        if (line.includes("Disclaimer: Charges/Adjustments made after statement date")) {
          if (currentSheetData.length > 0) {
            processExtractedSheet(currentSheetData.map(r => r.trim()).filter(Boolean));
            currentSheetData = [];
          }
        } else {
          currentSheetData.push(line.trim());
        }
      }
    }
    if (currentSheetData.length > 0) {
      processExtractedSheet(currentSheetData.map(r => r.trim()).filter(Boolean));
    }
    if (sheets.length === 0 || sheets.every(s => s.tableRows.length === 0)) {
      document.getElementById('output').textContent = "No valid statement data found.";
      document.getElementById('exportExcelBtn').disabled = true;
      document.getElementById('exportWordBtn').disabled = true;
    } else {
      let previewHTML = sheets.map((sheet, idx) => {
        let infoBlock = sheet.infoLines.map(l => `<div>${l}</div>`).join('');
        let tableBlock = `<table><tr>${HEADERS.map(h => `<th>${h}</th>`).join('')}</tr>` +
          sheet.tableRows.map(row =>
            '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
          ).join('') +
          `</table>`;
        return `<b>Statement ${idx + 1}</b><br>${infoBlock}<br>${tableBlock}`;
      }).join('<br>');
      document.getElementById('output').innerHTML = previewHTML;
      document.getElementById('exportExcelBtn').disabled = false;
      document.getElementById('exportWordBtn').disabled = false;
      showNotification("PDF data extracted for " + sheets.length + " statement(s)!");
    }
  } catch (e) {
    document.getElementById('output').textContent = "Error reading PDF!";
    document.getElementById('exportExcelBtn').disabled = true;
    document.getElementById('exportWordBtn').disabled = true;
    showNotification("Error: Could not extract PDF data.");
  }
});

document.getElementById('exportExcelBtn').onclick = function() {
  if (!sheets.length) return;
  const wb = XLSX.utils.book_new();
  sheets.forEach((sheet, idx) => {
    let wsData = [
      ...sheet.infoLines.map(l=>[l]),
      [],
      HEADERS,
      ...sheet.tableRows
    ];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, `Statement ${idx + 1}`);
  });
  XLSX.writeFile(wb, "Statements.xlsx");
};

document.getElementById('exportWordBtn').onclick = function() {
  exportToWord(sheets, HEADERS);
};

// ------- DOCX WORD EXPORT (ahhhhh.html Style) -------
function exportToWord(sheets, headers) {
  const {
    Document, Packer, Paragraph, Table, TableRow, TableCell,
    WidthType, TextRun, AlignmentType, BorderStyle, PageOrientation
  } = window.docx;

  const currentDate = new Date().toLocaleDateString('en-US', {
    year: 'numeric', month: '2-digit', day: '2-digit'
  });

  const sections = sheets.map((sheet, idx) => {
    // --- Extract client info from infoLines ---
    // Try to find client name and address lines by keywords
    let clientName = "[CLIENT NAME]";
    let addressLines = ["[ADDRESS LINE 1]", "[CITY, STATE ZIP]"];
    for (let line of sheet.infoLines) {
      if (/client name/i.test(line)) {
        clientName = line.replace(/.*client name[s]*\s*:/i, '').split('(')[0].trim();
        if (clientName.includes(',')) {
          const [last, first] = clientName.split(",");
          clientName = `${first.trim()} ${last.trim()}`;
        }
      } else if (/^\d{1,5} .*\d{5}$/.test(line)) {
        addressLines[0] = line.trim();
      } else if (/[,][ ]*[A-Z]{2} \d{5}/.test(line)) {
        addressLines[1] = line.trim();
      }
    }
    // fallback: always use infoLines[5] and infoLines[6] for address if available
    if (sheet.infoLines[4]) addressLines[0] = sheet.infoLines[4];
    if (sheet.infoLines[5]) addressLines[1] = sheet.infoLines[5];

    // --- Calculate total balance owed ---
    let balanceOwed = 0;
    let balanceColIdx = headers.findIndex(h => /balance owed|patient balance/i.test(h));
sheet.tableRows.forEach(row => {
  let val = row[balanceColIdx];
  if (typeof val === 'string') {
    val = parseFloat(val.replace(/[$,]/g, ''));
    if (!isNaN(val)) balanceOwed += val;
  }
});
// --- Filter out disclaimer rows ---
const validRows = sheet.tableRows.filter(row =>
  !(row[0] && row[0].toString().includes("Disclaimer: Charges/Adjustments made after statement date"))
);

    // --- Table rows ---
    const headerRow = new TableRow({
      children: headers.map(text =>
        new TableCell({
          children: [new Paragraph({ text, bold: true })],
          shading: { fill: "D3D3D3" }
        })
      )
    });

    const bodyRows = validRows.map((row, i) =>
      new TableRow({
        children: row.map((cell, colIdx) =>
          new TableCell({
            children: [new Paragraph({
              children: [new TextRun({ text: cell ?? '', size: 22, color: '000000' })]
            })]
          })
        )
      })
    );

    const totalRow = new TableRow({
      children: [
        new TableCell({
          children: [new Paragraph({ text: "Total", bold: true })],
          columnSpan: headers.length - 1,
          shading: { fill: "D3D3D3" }
        }),
        new TableCell({
          children: [new Paragraph({ text: `$${balanceOwed.toFixed(2)}`, bold: true })],
          shading: { fill: "D3D3D3" }
        })
      ]
    });

    // --- Pay amount box ---
    const payAmountBox = new Table({
      alignment: AlignmentType.RIGHT,
      width: { size: 50, type: WidthType.PERCENTAGE },
      rows: [
        new TableRow({
          children: [
            new TableCell({
              children: [
                new Paragraph({
                  alignment: AlignmentType.CENTER,
                  indent: { left: 750 },
                  children: [
                    new TextRun({
                      text: `PAY THIS AMOUNT: $${balanceOwed.toFixed(2)}`,
                      alignment: AlignmentType.CENTER,
                      bold: true,
                      size: 28
                    })
                  ]
                })
              ],
              borders: {
                top: { style: BorderStyle.SINGLE, size: 4 },
                bottom: { style: BorderStyle.SINGLE, size: 4 },
                left: { style: BorderStyle.SINGLE, size: 4 },
                right: { style: BorderStyle.SINGLE, size: 4 }
              }
            })
          ]
        })
      ]
    });

    // --- Section children ---
    return {
      properties: {
        page: {
          size: { width: 12240, height: 15840, orientation: PageOrientation.PORTRAIT },
          margin: { top: 360, bottom: 360, left: 360, right: 360 }
        }
      },
      children: [
        new Paragraph({
          alignment: AlignmentType.RIGHT,
          children: [new TextRun({ text: `Statement Date: ${currentDate}`, bold: true, size: 24 })],
          spacing: { after: 200 },
          indent: { left: 750 }
        }),
        payAmountBox,
        new Paragraph({ spacing: { after: 200 }, alignment: AlignmentType.CENTER, indent: { left: 750 } }),
        new Paragraph({ text: "", spacing: { after: 800 } }),
        new Paragraph({
          children: [new TextRun({ text: clientName, bold: true, size: 24 })],
          indent: { left: 1440 },
          spacing: { after: 150 }
        }),
        ...addressLines.map(line =>
          new Paragraph({
            children: [new TextRun({ text: line, size: 24, bold: true })],
            indent: { left: 1440 },
            spacing: { after: 150 }
          })
        ),
        new Paragraph({ spacing: { after: 750 } }),
        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [headerRow, ...bodyRows, totalRow]
        }),
        new Paragraph({
          children: [
            new TextRun({
              text: "Disclaimer: The Adjustment column shows total reductions applied to your charges. These include write-offs and adjustments from your insurance provider, as well as any discounts you may have received. Charges/adjustments made after statement date will appear on your next statement.",
              italics: true
            })
          ],
          spacing: { before: 200 }
        }),
        new Paragraph({
          children: [
            new TextRun({
              text: "For any questions, concerns, or to make a payment over the phone, please call Family Health Education Services at (605) 717-8920. Our billing team is available Monday - Thursday, 8:00 AM to 4:00 PM MT.",
              bold: true
            })
          ],
          spacing: { before: 200 }
        }),
        ...(idx < sheets.length - 1 ? [new Paragraph({ children: [], pageBreakBefore: true })] : [])
      ]
    };
  });

  const doc = new Document({ sections });

  window.docx.Packer.toBlob(doc).then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "Statements.docx";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 100);
  });
}
</script>
</body>
</html>