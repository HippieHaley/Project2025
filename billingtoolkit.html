<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Invoice/Statement Toolkit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      background: #acdbf9;
      color: #333;
      padding: 2em;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    input[type="file"], button {
      margin: 1em 0;
      padding: 0.8em 1.5em;
      border-radius: 30px;
      border: 1px solid #000;
      font-size: 1em;
      background: #f8c9f9;
      transition: background-color 0.2s;
    }
    button:disabled { background: #f0d4f0; color: #999; border: 1px solid #999; cursor: not-allowed; }
    button:hover:not(:disabled), input[type="file"]:hover { background: #e8b3e8; }
    #output { white-space: pre-wrap; background: #fff; padding: 1em; border-radius: 6px; margin-top: 1em; width: 100%; min-height: 200px; box-sizing: border-box;}
    .back-home {
      display: inline-block;
      padding: 12px 24px;
      background-color: #f8c9f9;
      color: #333;
      text-decoration: none;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 30px;
      text-align: center;
      border: 1px solid #000;
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 999;
      transition: background-color 0.2s ease;
    }
    .back-home:hover { background: #e8b3e8; }
    #notification {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f8c9f9;
      color: #333;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    table {
      border-collapse: collapse;
      margin: 1em 0;
      width: 100%;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 6px 10px;
      text-align: left;
      font-size: 0.95em;
    }
    th {
      background: #f8c9f9;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <a href="index.html" class="back-home">Back to Home</a>
  <h1>PDF Invoice/Statement Toolkit</h1>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button id="exportExcelBtn" disabled>Export to Excel</button>
  <div id="notification"></div>
  <div id="output"></div>
  <script>
    const HEADERS = [
      "Claim Number", "Service Date(s)", "Procedure", "Units", "Unit Rate",
      "Total Charge", "Patient Charge", "Total Paid", "Ins. Paid",
      "Patient Paid", "Total Adj.", "Total Balance", "Ins. Balance", "Patient Balance"
    ];

    let sheets = [];

    function cleanLine(line) {
      return line
        .replace(/State\s+of\s+South\s+Dakota\s+Department\s+of\s+Health/gi, '')
        .replace(/South Dakota Department of Health/gi, '')
        .replace(/600\s+E\s+Capitol\s+Ave/gi, '')
        .replace(/Pierre,\s+SD\s+57501/gi, '')
        .replace(/Payment Type:.*$/i, '')
        .replace(/Card Type:.*$/i, '')
        .replace(/Name on Card:.*$/i, '')
        .replace(/Card Number:.*$/i, '')
        .replace(/Expiration Date:.*$/i, '')
        .replace(/Amount Enclosed:.*$/i, '')
        .trim();
    }

    function showNotification(msg) {
      const n = document.getElementById("notification");
      n.textContent = msg;
      n.style.display = "block";
      setTimeout(() => { n.style.display = "none"; }, 3000);
    }

    function parseTableRow(line) {
      const tokens = line.trim().split(/\s+/);
      if (tokens.length < 5) return Array(HEADERS.length).fill('');
      let dateIdx = tokens.findIndex(tok => /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(tok));
      if (dateIdx === -1) return Array(HEADERS.length).fill('');
      const claimNumber = tokens.slice(0, dateIdx).join(' ');
      const serviceDate = tokens[dateIdx];
      let i = dateIdx + 1;
      let procedureTokens = [];
      while (i < tokens.length && !/^\d+$/.test(tokens[i])) {
        procedureTokens.push(tokens[i]);
        i++;
      }
      const procedure = procedureTokens.join(' ');
      const units = tokens[i] || '';
      i++;
      const unitRate = tokens[i] || '';
      i++;
      let rest = [];
      while (i < tokens.length) { rest.push(tokens[i]); i++; }
      while (rest.length < 9) rest.push('');
      return [
        claimNumber, serviceDate, procedure, units, unitRate,
        rest[0], rest[1], rest[2], rest[3], rest[4], rest[5], rest[6], rest[7], rest[8]
      ];
    }

    function processExtractedSheet(flattened) {
      let infoLines = [];
      let headerIdx = flattened.findIndex(l => l.toLowerCase().startsWith("claim number"));
      if (headerIdx > 0) infoLines = flattened.slice(0, headerIdx);
      let tableLines = [];
      if (headerIdx !== -1) {
        for (let i = headerIdx + 1; i < flattened.length; i++) {
          let line = flattened[i];
          if (/^totals?/i.test(line) || /^balances?/i.test(line) ||
              /^patient'?s unapplied balance/i.test(line) || /disclaimer/i.test(line)) break;
          if (line.trim()) tableLines.push(line);
        }
      }
      const tableRows = tableLines.map(parseTableRow);
      sheets.push({ infoLines, tableRows });
    }

    document.getElementById('fileInput').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (!file) return;
      sheets = [];
      document.getElementById('output').textContent = "Extracting PDF...";
      document.getElementById('exportExcelBtn').disabled = true;
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdfData = new Uint8Array(arrayBuffer);
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        let currentSheetData = [];
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          let line = '', lastY = null;
          textContent.items.forEach(item => {
            if (lastY !== null && Math.abs(item.transform[5] - lastY) > 10) {
              line = cleanLine(line);
              if (line.includes("Disclaimer: Charges/Adjustments made after statement date")) {
                if (currentSheetData.length > 0) {
                  processExtractedSheet(currentSheetData.map(r => r.trim()).filter(Boolean));
                  currentSheetData = [];
                }
              } else {
                currentSheetData.push(line.trim());
              }
              line = '';
            }
            line += item.str + ' ';
            lastY = item.transform[5];
          });
          if (line.trim()) {
            line = cleanLine(line);
            if (line.includes("Disclaimer: Charges/Adjustments made after statement date")) {
              if (currentSheetData.length > 0) {
                processExtractedSheet(currentSheetData.map(r => r.trim()).filter(Boolean));
                currentSheetData = [];
              }
            } else {
              currentSheetData.push(line.trim());
            }
          }
        }
        if (currentSheetData.length > 0) {
          processExtractedSheet(currentSheetData.map(r => r.trim()).filter(Boolean));
        }
        if (sheets.length === 0 || sheets.every(s => s.tableRows.length === 0)) {
          document.getElementById('output').textContent = "No valid statement data found.";
          document.getElementById('exportExcelBtn').disabled = true;
        } else {
          let previewHTML = sheets.map((sheet, idx) => {
            let infoBlock = sheet.infoLines.map(l => `<div>${l}</div>`).join('');
            let tableBlock = `<table><tr>${HEADERS.map(h => `<th>${h}</th>`).join('')}</tr>` +
              sheet.tableRows.map(row =>
                '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
              ).join('') +
              `</table>`;
            return `<b>Statement ${idx + 1}</b><br>${infoBlock}<br>${tableBlock}`;
          }).join('<br>');
          document.getElementById('output').innerHTML = previewHTML;
          document.getElementById('exportExcelBtn').disabled = false;
          showNotification("PDF data extracted for " + sheets.length + " statement(s)!");
        }
      } catch (e) {
        document.getElementById('output').textContent = "Error reading PDF!";
        document.getElementById('exportExcelBtn').disabled = true;
        showNotification("Error: Could not extract PDF data.");
      }
    });

    // Helper to get max string width for each column
    function getColWidths(wsData) {
      let maxCol = 0;
      wsData.forEach(row => { if (row.length > maxCol) maxCol = row.length; });
      let colWidths = Array(maxCol).fill(10); // Default min width
      wsData.forEach(row => {
        row.forEach((cell, i) => {
          let len = cell ? cell.toString().length : 0;
          if (len > colWidths[i]) colWidths[i] = len;
        });
      });
      return colWidths.map(w => ({ wch: w + 2 }));
    }

    document.getElementById('exportExcelBtn').onclick = function() {
      if (!sheets.length) return;
      const wb = XLSX.utils.book_new();
      sheets.forEach((sheet, idx) => {
        let wsData = [];

        // Row 1: Statement Date, Client Name(s), (columns M or N) Pay Amount
        let statementDate = ""; // parse from infoLines if available!
        let clientName = "";
        let payAmount = "";
        sheet.infoLines.forEach(l => {
          if (/statement date/i.test(l)) statementDate = l;
          if (/client name/i.test(l)) clientName = l;
          if (/pay.*amount/i.test(l)) payAmount = l;
        });
        // Place payAmount at column M (index 12)
        let row1 = Array(13).fill("");
        row1[0] = statementDate;
        row1[1] = clientName;
        row1[12] = payAmount;
        wsData.push(row1);

        // Row 2: blank
        wsData.push(Array(13).fill(""));

        // Row 3: blank (top margin)
        wsData.push(Array(13).fill(""));

        // Address block: rows 4-6, column A only
        let addressLines = [];
        sheet.infoLines.forEach(l => {
          if (/(anderson|wall st|apt|lead, sd|[0-9]{5})/i.test(l)) addressLines.push(l);
        });
        wsData.push([addressLines[0] || "", ...Array(12).fill("")]);
        wsData.push([addressLines[1] || "", ...Array(12).fill("")]);
        wsData.push([addressLines[2] || "", ...Array(12).fill("")]);

        // Row 7: blank
        wsData.push(Array(13).fill(""));

        // Row 8: Client ID and Client Name
        let clientIdLine = sheet.infoLines.find(l => /client id/i.test(l)) || "";
        wsData.push([clientIdLine, ...Array(12).fill("")]);

        // Row 9: blank
        wsData.push(Array(13).fill(""));

        // Row 10: Table headers
        wsData.push([...HEADERS]);

        // Table data, starting at row 11
        sheet.tableRows.forEach(row => wsData.push(row));

        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Auto-fit columns
        ws['!cols'] = getColWidths(wsData);

        XLSX.utils.book_append_sheet(wb, ws, `Statement ${idx + 1}`);
      });

      XLSX.writeFile(wb, "Statements.xlsx");
    };
  </script>
</body>
</html>