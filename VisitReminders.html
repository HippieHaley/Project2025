<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    body {
            font-family: Arial, sans-serif;
            background-color: #acdbf9; /* Light blue background */
            color: #333;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background-color: #f8c9f9;
  border: 2px solid #333;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
th, td {
  padding: 20px;
  border: 1px solid #333;
  background-color: #f8c9f9;
  color: #333;
  text-align: center;
}
th:last-child, td:last-child {
  padding: 8px;
  width: 1%;
  white-space: nowrap;
}
input[type="email"],
input[type="date"],
input[type="time"] {
  width: 100%;
  padding: 10px;
  border: 1px solid #000;
  border-radius: 20px;
  background-color: #ffffff;
  color: #333;
  font-size: 1rem;
  text-align: center;
  box-sizing: border-box;
}
input[type="date"]::placeholder {
  color: #999;
  font-weight: bold;
}
input[type="date"]:invalid {
  color: #999;
}
input:focus {
  background-color: #acdbf9; 
  outline: none;
  box-shadow: 0 0 5px rgba(232, 184, 232, 0.5);
}
input.dimmed {
  background-color: #e0e0e0 !important;
  color: #666 !important;
  pointer-events: none;
}

button {
  padding: 12px 24px;
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  background-color: #acdbf9; 
  border: 1px solid #000;
  border-radius: 20px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}
button:hover {
  background-color: #acdbf9; 
}
.alt-button {
  padding: 12px 24px;
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  background-color: #f8c9f9; /* pastel pink */
  border: 1px solid #000;
  border-radius: 20px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.alt-button:hover {
  background-color: #e8b3e8; /* slightly darker pink on hover */
}

#preview {
  margin-top: 30px;
  background-color:#e8b3e8;
  border-radius: 30px;
  color: #333;
  font-size: 1rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}
/* Back Home Button */
.back-home {
          display: inline-block;
          padding: 12px 24px;
          background-color: #f8c9f9;
          color: #333;
          text-decoration: none;
          font-size: 1rem;
          font-weight: bold;
          border-radius: 20px;
          text-align: center;
          border: 1px solid #000;
          top: 20px;
          left: 20px;
          z-index: 999; /* Ensures it stays above other elements */
          transition: background-color 0.2s ease;
          position: absolute;
        }
        .back-home:hover {
          background-color: #e8b3e8;
        }
        .alert-preview {
  position: fixed;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background-color: #e8b3e8;
  padding: 20px;
  border-radius: 50%;
  width: 40px;   /* suspect issue here */
  height: 40px;  /* suspect issue here */
  display: none; /* should be hidden by default */
  justify-content: center;
  align-items: center;
  text-align: center;
  z-index: 1000;
}
#preview {
  display: none; /* initially hidden, JS shows this as needed */
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  background-color: #e8b3e8;
  padding: 15px;
  border-radius: 10px;
  border: 1px solid #000;
  max-width: 300px;
  z-index: 1000;
  overflow-y: auto;
  text-align: center; /* makes your default message look nice */
}
.notification {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #acdbf9; 
  color: #333;
  padding: 10px 15px;
  border: 2px solid #333;
  border-radius: 20px;
  font-weight: bold;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
  z-index: 9999;
  max-width: 90%;
  text-align: center;
}
.notification.show {
  opacity: 1;
}
.template-selector {
  padding: 8px 32px 8px 12px;
  border-radius: 20px;
  border: 1px solid #333;
  background-color: #acdbf9; 
  color: #333;
  font-size: 1rem;
  font-weight: bold;
  text-align: center;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  margin-left: 8px;
  margin-right: 8px;
  background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
  background-repeat: no-repeat;
  background-position: right 8px center;
  background-size: 20px;
}
.template-selector:focus {
  outline: none;
  border-color: #000;
  background-color: #acdbf9; 
}
.time-selector {
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #000;
  background-color: #ffffff; 
  color: #333;
  font-size: 1rem;
  font-weight: bold;
  text-align: center;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  width: 100%;
  box-sizing: border-box;
}
.time-selector:focus {
  outline: none;
  border-color: #000;
  background-color: #acdbf9;
  box-shadow: 0 0 5px rgba(232, 184, 232, 0.5);
}
.time-selector option[value=""] {
  color: #000000;
  font-style: italic;
}
.time-selector:invalid {
  color: #999;
  font-style: italic;
}
.sms-email-input {
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #000;
  font-size: 1rem;
  font-weight: normal;
  background-color: #ffffff; 
  color: #333;
  width: 100%;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  transition: border-color 0.2s ease, background-color 0.2s ease;
  box-sizing: border-box;
}
.sms-email-input::placeholder {
  color: #999;
  font-weight: bold;
    color: #999;
  font-style: italic;
}
.sms-email-input:focus {
  outline: none;
  border-color: #000;
  background-color: #acdbf9;
  box-shadow: 0 0 5px rgba(232, 184, 232, 0.5);
}
  </style>
</head>
<body>  
  <a href="index.html" class="back-home">Back to Home</a>
  <div style="display: flex; align-items: flex-start; gap: 10px;">
    <div style="flex-grow: 1;">
      <h1>Draft Generator</h1>      
      <table id="emailTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Date</th>
          <th>Time</th>
          <th>Actions</th>
        </tr>
      </thead>       
      <tr><button class="alt-button" onclick="addRow()" >+ Add Row</button> 
        <button class="alt-button" onclick="createDraft()" style="margin-left: 60px;">Create Drafts</button>
      <tbody> 
      <div style="margin-bottom: 10px;"></div>    
          <td><input type="email" class="sms-email-input" placeholder="Email"></td>
          <td><input type="date" placeholder="Date"></td>
          <td>
            <select class="time-selector" required>
              <option value="" disabled selected hidden>Time</option>
              <option value="08:00">8:00 AM</option>
              <option value="08:15">8:15 AM</option>
              <option value="08:30">8:30 AM</option>
              <option value="08:45">8:45 AM</option>
              <option value="09:00">9:00 AM</option>
              <option value="09:15">9:15 AM</option>
              <option value="09:30">9:30 AM</option>
              <option value="09:45">9:45 AM</option>
              <option value="10:00">10:00 AM</option>
              <option value="10:15">10:15 AM</option>
              <option value="10:30">10:30 AM</option>
              <option value="10:45">10:45 AM</option>
              <option value="11:00">11:00 AM</option>
              <option value="11:15">11:15 AM</option>
              <option value="11:30">11:30 AM</option>
              <option value="11:45">11:45 AM</option>
              <option value="12:00">12:00 PM</option>
              <option value="12:15">12:15 PM</option>
              <option value="12:30">12:30 PM</option>
              <option value="12:45">12:45 PM</option>
              <option value="13:00">1:00 PM</option>
              <option value="13:15">1:15 PM</option>
              <option value="13:30">1:30 PM</option>
              <option value="13:45">1:45 PM</option>
              <option value="14:00">2:00 PM</option>
              <option value="14:15">2:15 PM</option>
              <option value="14:30">2:30 PM</option>
              <option value="14:45">2:45 PM</option>
              <option value="15:00">3:00 PM</option>
              <option value="15:15">3:15 PM</option>
              <option value="15:30">3:30 PM</option>
              <option value="15:45">3:45 PM</option>
              <option value="16:00">4:00 PM</option>
              <option value="16:15">4:15 PM</option>
              <option value="16:30">4:30 PM</option>
              <option value="16:45">4:45 PM</option>
              <option value="17:00">5:00 PM</option>
            </select>
          </td>
          <td>
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
              <label style="display:inline-flex;align-items:center;">
                <input type="checkbox" class="income-doc-checkbox" style="margin-right:6px;"> income docs needed
              </label>
              <select class="template-selector">
                <option value="default">Appt Reminder</option>
                <option value="reschedule">Reschedule</option>
                <option value="CallClinic">Call Clinic</option>
                <option value="AEDue">AE Due</option>
                <option value="MissedAppt">Missed Appt</option>
                <option value="IncomeDocReminder">Income Doc Reminder </option>
              </select>
              <button onclick="deleteRow(this)">Delete row</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    </div>
  </div>
  <script>
    function addRow() {
      const table = document.getElementById('emailTable').getElementsByTagName('tbody')[0];
      const newRow = table.rows[0].cloneNode(true);
      const inputs = newRow.getElementsByTagName('input');
      for (let input of inputs) {
        input.value = '';
      }
      table.appendChild(newRow);
    }
    function setupSmsAutocomplete() {
      // Remove any existing listeners and rebind to all current .sms-email-input fields
      document.querySelectorAll('.sms-email-input').forEach(input => {
        // Remove previous event listener if any
        input.removeEventListener('input', handleSmsAutocomplete);
        input.addEventListener('input', handleSmsAutocomplete);
        input.dataset.bound = 'true';
      });
    }

    function handleSmsAutocomplete(e) {
      const input = e.target;
      let value = input.value;
      
      // Strip all non-digit characters to check if it's a phone number
      const sanitized = value.replace(/\D/g, '');
      
      // Check if input contains only numbers and phone formatting characters
      const isPhoneNumber = /^[\d\s\-\(\)]+$/.test(value) && sanitized.length > 0;
      
      // If it's a phone number format, clean it up and show suggestions
      if (isPhoneNumber && sanitized.length >= 7) {
        // Auto-clean the input to show only digits
        if (value !== sanitized) {
          input.value = sanitized;
        }
        
        const providers = [
          '@txt.att.net',
          '@tmomail.net',
          '@vtext.com',
          '@messaging.sprintpcs.com',
          '@vmobl.com',
          '@mypixmessages.com',
          '@mymetropcs.com',
          '@sms.cricketwireless.net'
        ];
        showSmsSuggestions(input, sanitized, providers);
      } 
      // If it contains @ and numbers before @, it's a text message email
      else if (value.includes('@') && /^\d+@/.test(value)) {
        // Already an SMS email format, don't interfere
        clearSmsSuggestions();
      }
      // If it contains @ or has letters (regular email), show common email domains
      else if (value.includes('@') || /[a-zA-Z]/.test(value)) {
        showEmailSuggestions(input, value);
      } 
      else {
        clearSmsSuggestions();
      }
    }
    
    function showEmailSuggestions(input, value) {
      clearSmsSuggestions();
      
      // Split by @ to get the username part
      const parts = value.split('@');
      const username = parts[0];
      const domain = parts[1] || '';
      
      if (!username) return;
      
      const commonDomains = [
        '@gmail.com',
        '@yahoo.com',
        '@hotmail.com',
        '@outlook.com',
        '@icloud.com',
        '@aol.com',
      ];
      
      // Filter domains that match what user is typing after @
      const matchingDomains = domain 
        ? commonDomains.filter(d => d.toLowerCase().includes('@' + domain.toLowerCase()))
        : commonDomains;
      
      if (matchingDomains.length === 0) return;
      
      const container = document.createElement('div');
      container.setAttribute('id', 'smsSuggestionContainer');
      container.style.border = '1px solid #333';
      container.style.background = '#fff';
      container.style.position = 'absolute';
      container.style.zIndex = '9999';
      container.style.width = `${input.offsetWidth}px`;
      container.style.maxHeight = '200px';
      container.style.overflowY = 'auto';
      
      const rect = input.getBoundingClientRect();
      container.style.left = `${rect.left + window.scrollX}px`;
      container.style.top = `${rect.bottom + window.scrollY}px`;
      
      matchingDomains.forEach(domain => {
        const item = document.createElement('div');
        const suggestion = username + domain;
        item.textContent = suggestion;
        item.style.padding = '8px';
        item.style.cursor = 'pointer';
        item.style.backgroundColor = '#f8c9f9';
        item.style.borderBottom = '1px solid #e0e0e0';
        item.addEventListener('mouseenter', () => {
          item.style.backgroundColor = '#e8b3e8';
        });
        item.addEventListener('mouseleave', () => {
          item.style.backgroundColor = '#f8c9f9';
        });
        item.addEventListener('click', () => {
          input.value = suggestion;
          clearSmsSuggestions();
        });
        container.appendChild(item);
      });
      
      document.body.appendChild(container);
    }
    function showSmsSuggestions(input, number, providers) {
      clearSmsSuggestions();
      const container = document.createElement('div');
      container.setAttribute('id', 'smsSuggestionContainer');
      container.style.border = '1px solid #333';
      container.style.background = '#fff';
      container.style.position = 'absolute';
      container.style.zIndex = '9999';
      container.style.width = `${input.offsetWidth}px`;
      // Position relative to input field
      const rect = input.getBoundingClientRect();
      container.style.left = `${rect.left + window.scrollX}px`;
      container.style.top = `${rect.bottom + window.scrollY}px`;

      const labeledProviders = [
        { label: 'Verizon', domain: '@vtext.com' },
        { label: 'T-Mobile', domain: '@tmomail.net' },
        { label: 'Sprint', domain: '@messaging.sprintpcs.com' },
        { label: 'Virgin', domain: '@vmobl.com' },
        { label: 'MetroPCS', domain: '@mymetropcs.com' },
        { label: 'Cricket', domain: '@sms.cricketwireless.net' },
        { label: 'Pix Wireless', domain: '@mypixmessages.com' },
        { label: 'AT&T', domain: 'NO LONGER AVAILABLE' }
      ];

      labeledProviders.forEach(({ label, domain }) => {
        const item = document.createElement('div');
        const fullAddress = number + domain;
        item.textContent = `(${label}) ${fullAddress}`;
        item.style.padding = '8px';
        item.style.cursor = 'pointer';
        item.style.backgroundColor = '#f8c9f9';
        item.addEventListener('click', () => {
          input.value = fullAddress;
          clearSmsSuggestions();
        });
        container.appendChild(item);
      });
      document.body.appendChild(container);
    }

    function clearSmsSuggestions() {
      const existingContainer = document.getElementById('smsSuggestionContainer');
      if (existingContainer) {
        existingContainer.remove();
      }
    }

  function updateInputVisibility(row) {
  const templateSelector = row.querySelector('.template-selector');
  const selectedTemplate = templateSelector ? templateSelector.value : 'default';

  const dateInput = row.querySelector('input[type="date"]');
  const timeInput = row.querySelector('.time-selector');

  // Reset all inputs first
  dateInput.classList.remove('dimmed');
  timeInput.classList.remove('dimmed');
  dateInput.removeAttribute('disabled');
  timeInput.removeAttribute('disabled');

  // Apply dimmed style based on template logic
  if (selectedTemplate === 'AEDue') {
    timeInput.classList.add('dimmed');
    timeInput.setAttribute('disabled', true);
  } else if (selectedTemplate === 'CallClinic') {
    dateInput.classList.add('dimmed');
    dateInput.setAttribute('disabled', true);
    timeInput.classList.add('dimmed');
    timeInput.setAttribute('disabled', true);
  }
}
function setupTemplateListeners() {
  document.querySelectorAll('.template-selector').forEach(selector => {
    selector.addEventListener('change', () => {
      const row = selector.closest('tr');
      updateInputVisibility(row); // This is the function from Step 2
    });
  });
}

  document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('sms-email-input')) {
      clearSmsSuggestions();
    }
  });

  // Hook it on load
  window.addEventListener('DOMContentLoaded', setupSmsAutocomplete);

  const originalAddRow = addRow;
addRow = function () {
  originalAddRow();
  setupSmsAutocomplete();
  setupTemplateListeners(); // NEW!
};

    function deleteRow(button) {
      const row = button.closest('tr');
      const table = document.getElementById('emailTable').getElementsByTagName('tbody')[0];
      if (table.rows.length > 1) {
        row.remove();
      } else {
        alert("You must have at least one row.");
      }
    }
function formatTime12H(time) {
  if (!time) return '';
  let [hour, minute] = time.split(":");
  hour = parseInt(hour, 10);
  const ampm = hour >= 12 ? "PM" : "AM";
  hour = hour % 12;
  if (hour === 0) hour = 12;
  return `${hour}:${minute} ${ampm}`;
}

function getEmailRowData(row) {
  const inputs = row.getElementsByTagName('input');
  const email = inputs[0].value;
  const date = inputs[1].value;
  const timeSelector = row.querySelector('.time-selector');
  const time = timeSelector ? timeSelector.value : '';
  const formattedTime = formatTime12H(time);

  const templateSelector = row.querySelector('.template-selector');
  const selectedTemplate = templateSelector ? templateSelector.value : 'default';

  const templates = {
    default: `Please send YES to confirm your appt on ${date} @ ${formattedTime}.\nCall to cancel, reschedule, or if you have questions.\n605-717-8920. Thank you.`,
    reschedule: `We need to reschedule your appt originally set for ${date} @ ${formattedTime}.\nPlease call us at 605-717-8920. Thank you.`,
    CallClinic: `We called you on ${new Date().toLocaleDateString()}.\nIt's important you get in touch with the clinic.\nPlease call us at 605-717-8920. Thank you.`,
    AEDue: `Its about that time! Your annual exam is due ${date}.\nPlease call us at 605-717-8920 to schedule your appointment. Thank you.`,
    MissedAppt: `We missed you at your appointment on ${date} @ ${formattedTime}.\nPlease call us at 605-717-8920 to reschedule. Thank you.`,
    IncomeDocReminder: `Please bring some sort of income documentation for your appointment on ${date}. This could be w-2s or a month of paystubs. Thank you.`,
  };

  const subject = 'SECUREMAIL From Monument Health FHES.';
  const body = templates[selectedTemplate] || templates.default;

  return { email, subject, body };
}
function createDraft() {
  const table = document.getElementById('emailTable').getElementsByTagName('tbody')[0];
  const rows = table.getElementsByTagName('tr');
  
  let delay = 0;
  
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const { email, subject, body } = getEmailRowData(row);
    
    if (!email) {
      continue; // Skip rows without email
    }
    
    // Create main draft
    const currentDelay = delay;
    setTimeout(() => {
      let mailto = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailto, '_blank');
    }, currentDelay);
    delay += 500;
    
    // Only create Income Doc Reminder draft if checkbox is checked
    const incomeDocCheckbox = row.querySelector('.income-doc-checkbox');
    if (incomeDocCheckbox && incomeDocCheckbox.checked) {
      const inputs = row.getElementsByTagName('input');
      const date = inputs[1].value;
      const incomeDocSubject = 'SECUREMAIL From Monument Health.';
      const incomeDocBody = `Please bring some sort of income documentation for your appointment on ${date}. This could be w-2s or a month of paystubs. Thank you.`;
      const incomeMailto = `mailto:${email}?subject=${encodeURIComponent(incomeDocSubject)}&body=${encodeURIComponent(incomeDocBody)}`;
      const incomeDelay = delay;
      setTimeout(() => {
        window.open(incomeMailto, '_blank');
      }, incomeDelay);
      delay += 500;
    }
  }
}
window.addEventListener('DOMContentLoaded', () => {
  setupSmsAutocomplete();
  setupTemplateListeners(); // NEW!
});
  </script>
</body>
</html>